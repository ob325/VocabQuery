#+title: VocabQuery Readme
#+header-args: R :session s1 

* Installation

#+begin_src R :session s1 :exports none 

  devtools::load_all()
  
#+end_src

#+RESULTS:

#+begin_src R :session s1 :eval no 

  remotes::install_github("ob325/VocabQuery")
  
#+end_src

#+begin_src R :session s1 :exports code :results none

  library("Eunomia")
  library("knitr")
  library("dplyr") 
    
#+end_src

* Connect to the CDM

#+begin_src R :session s1 :results output 

  if (!exists("connectionDetails")) {
    connectionDetails <- Eunomia::getEunomiaConnectionDetails()
  } 

#+end_src

#+RESULTS:

* Find concepts

I want to find the concept for RxNorm standard ingredient `celecoxib`.

#+begin_src R :session s1 :results output  :exports both 

    VocabQuery::queryConceptName(
                  connectionDetails,
                  schema = "main",
                  pattern = "celecox%",
                  domain = 'Drug',
                  vocab = 'RxNorm',
                  class = 'Ingredient')

#+end_src

#+RESULTS:
: Connecting using SQLite driver
: 
: 
: | concept_id|concept_name |vocabulary_id |standard_concept |domain_id |vocabulary_id |concept_class_id |
: |----------:|:------------|:-------------|:----------------|:---------|:-------------|:----------------|
: |    1118084|celecoxib    |RxNorm        |S                |Drug      |RxNorm        |Ingredient       |

* Distinct values of columns

#+begin_src R :session s1 :results output  :exports both 

  VocabQuery::conceptTableDistinctValues(
                connectionDetails,
                column = "vocabulary_id",
                schema = "main")


#+end_src

#+RESULTS:
#+begin_example
Connecting using SQLite driver
  vocabulary_id
1           CVX
2        Gender
3       ICD10CM
4         LOINC
5           NDC
6          None
7        RxNorm
8        SNOMED
9         Visit
#+end_example

#+begin_src R :session s1 :results output  :exports both 

  VocabQuery::conceptTableDistinctValues(
                connectionDetails,
                column = "concept_class_id",
                schema = "main")


#+end_src

#+RESULTS:
#+begin_example
Connecting using SQLite driver
       concept_class_id
1          11-digit NDC
2   3-char nonbill code
3   4-char billing code
4          Branded Drug
5     Branded Drug Comp
6          Branded Pack
7                   CVX
8         Clinical Drug
9    Clinical Drug Comp
10     Clinical Finding
11 Clinical Observation
12    Context-dependent
13               Gender
14           Ingredient
15             Lab Test
16    Morph Abnormality
17            Procedure
18   Quant Branded Drug
19  Quant Clinical Drug
20            Undefined
21                Visit
#+end_example

* Descendants of a standard concept

Note: Eunomia's concept table doesn't have a row for 75053 so we manually fill in the values below

#+begin_src R :session s1 :results output :exports both 

  VocabQuery::descendants(
                connectionDetails,
                schema = "main",
                conceptId = 75053) |>
    mutate(ancestor_concept_name = 'Fracture of bone') |>
    kable() 

#+end_src

#+RESULTS:
#+begin_example
Connecting using SQLite driver
  ancestor_concept_id ancestor_concept_name descendant_concept_id
1               75053      Fracture of bone               4230399
2               75053      Fracture of bone               4059173
3               75053      Fracture of bone               4048695
4               75053      Fracture of bone               4066995
5               75053      Fracture of bone               4278672
6               75053      Fracture of bone               4237458
7               75053      Fracture of bone              40480160
8               75053      Fracture of bone               4142905
9               75053      Fracture of bone               4134304
                                  descendant_concept_name
1                                  Closed fracture of hip
2                                       Fracture of ankle
3 Fracture of vertebral column without spinal cord injury
4    Fracture of vertebral column with spinal cord injury
5                                     Fracture of forearm
6                                    Fracture of clavicle
7               Pathological fracture due to osteoporosis
8                                         Fracture of rib
9                           Fracture subluxation of wrist
#+end_example
